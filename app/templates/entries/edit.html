<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} | Eureka</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <style>
        :root {
            --color-accent: #F9B234;
            --color-text-light: #333333;
            --color-text-dark: #E0E0E0;
            --color-bg-light: #FFFFFF;
            --color-bg-dark: #121212;
            --color-sec-light-1: #F5F5F5;
            --color-sec-light-2: #E0E0E0;
            --color-sec-dark-1: #2D2D2D;
            --color-sec-dark-2: #3D3D3D;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .theme-light {
            background-color: var(--color-bg-light);
            color: var(--color-text-light);
        }
        .theme-dark {
            background-color: var(--color-bg-dark);
            color: var(--color-text-dark);
        }
        .accent {
            color: var(--color-accent);
        }
        .btn-minimal {
            border: 1px solid var(--color-sec-light-2);
            border-radius: 4px;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }
        .btn-minimal:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
        }
        .btn-accent {
            background-color: var(--color-accent);
            color: white;
            border-radius: 4px;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }
        .btn-accent:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        /* Estilos para EasyMDE en tema claro/oscuro */
        .theme-light .EasyMDEContainer .CodeMirror {
            background-color: #fff;
            color: #333;
            border-color: var(--color-sec-light-2);
        }
        .theme-dark .EasyMDEContainer .CodeMirror {
            background-color: var(--color-sec-dark-1);
            color: var(--color-text-dark);
            border-color: var(--color-sec-dark-2);
        }
        .theme-dark .editor-toolbar {
            background-color: var(--color-sec-dark-2);
            border-color: var(--color-sec-dark-2);
        }
        .theme-dark .editor-toolbar button {
            color: var(--color-text-dark) !important;
        }
        .theme-dark .editor-toolbar button:hover {
            background-color: var(--color-sec-dark-1) !important;
        }
        .theme-dark .editor-toolbar.fullscreen {
            background-color: var(--color-bg-dark);
        }
        .theme-dark .editor-preview {
            background-color: var(--color-sec-dark-1);
            color: var(--color-text-dark);
        }
        .textarea-title {
            resize: none;
            border: none;
            outline: none;
            width: 100%;
            font-size: 1.5rem;
            font-weight: 600;
            background-color: transparent;
            margin-bottom: 1rem;
        }
        .textarea-title:focus {
            outline: none;
        }
        /* Estado de guardado */
        #save-status {
            transition: opacity 0.3s ease;
        }
        .save-icon {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>
</head>
<body class="theme-light min-h-screen">
    <!-- Barra superior -->
    <header class="border-b border-gray-200 py-4">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold">
                    <a href="{{ url_for('main.index') }}"><span class="accent">E</span>ureka</a>
                </h1>
            </div>
            <div class="flex items-center space-x-4">
                <div id="save-status" class="text-sm text-gray-500 flex items-center">
                    <span class="save-icon hidden mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M10.293 11.293a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 13.414V19a1 1 0 11-2 0v-5.586l-2.293 2.293a1 1 0 01-1.414-1.414l3-3z" clip-rule="evenodd" />
                        </svg>
                    </span>
                    <span class="save-text"></span>
                </div>
                <button class="btn-minimal flex items-center" id="theme-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
                    </svg>
                    Tema
                </button>
                <a href="{{ url_for('entry.list_entries') }}" class="btn-minimal flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    Volver
                </a>
            </div>
        </div>
    </header>

    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages container mx-auto px-6 mt-4">
                {% for category, message in messages %}
                    {% set alert_class = 'bg-green-100 border-green-500 text-green-700' if category == 'success' else
                                         'bg-red-100 border-red-500 text-red-700' if category == 'error' else
                                         'bg-yellow-100 border-yellow-500 text-yellow-700' if category == 'warning' else
                                         'bg-blue-100 border-blue-500 text-blue-700' %}
                    <div class="p-4 mb-4 {{ alert_class }} border-l-4 rounded" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Contenido principal -->
    <div class="container mx-auto px-6 py-8 flex flex-col max-w-5xl">
        <!-- Formulario de entrada -->
        <form id="entry-form" method="POST" action="{{ url_for('entry.update_entry', entry_id=entry.id) if entry else url_for('entry.create_entry') }}">
            <input type="hidden" name="entry_id" id="entry_id" value="{{ entry.id if entry else '0' }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <!-- Título -->
            <div class="mb-4">
                <textarea name="title" id="title" class="textarea-title" placeholder="Título de la entrada" required>{{ entry.title if entry else '' }}</textarea>
            </div>
            
            <!-- Editor Markdown -->
            <div class="mb-6">
                <textarea name="content" id="content" placeholder="Comienza a escribir tu idea...">{{ entry.content if entry else '' }}</textarea>
            </div>
            
            <!-- Opciones y metadatos -->
            <div class="flex flex-wrap gap-4 mb-6">
                <!-- Colección -->
                <div class="w-full md:w-64">
                    <label for="collection_id" class="block text-sm font-medium text-gray-700 mb-1">Colección</label>
                    <select name="collection_id" id="collection_id" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Sin colección</option>
                        <!-- Aquí se cargarían las colecciones del usuario -->
                    </select>
                </div>
                
                <!-- Etiquetas -->
                <div class="w-full md:flex-1">
                    <label for="tags" class="block text-sm font-medium text-gray-700 mb-1">Etiquetas (separadas por comas)</label>
                    <input type="text" name="tags" id="tags" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="eureka, idea, proyecto" value="{{ tags if tags else '' }}">
                </div>
            </div>
            
            <!-- Botones -->
            <div class="flex justify-between">
                <div>
                    {% if entry and entry.id %}
                    <button type="button" id="delete-btn" class="btn-minimal text-red-600 border-red-300" hx-post="{{ url_for('entry.delete_entry', entry_id=entry.id) }}" hx-confirm="¿Estás seguro de que deseas mover esta entrada a la papelera?">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Eliminar
                    </button>
                    {% endif %}
                </div>
                <div class="flex space-x-4">
                    <a href="{{ url_for('entry.list_entries') }}" class="btn-minimal">Cancelar</a>
                    <button type="submit" class="btn-accent">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 inline" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Guardar
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Inicializar EasyMDE
        var easyMDE = new EasyMDE({
            element: document.getElementById('content'),
            autosave: {
                enabled: false,  // Lo gestionaremos nosotros con HTMX
                delay: 30000
            },
            spellChecker: false,
            status: ["lines", "words", "cursor"],
            toolbar: [
                "bold", "italic", "heading", "|", 
                "quote", "unordered-list", "ordered-list", "|", 
                "link", "image", "table", "|", 
                "preview", "side-by-side", "fullscreen", "|", 
                "guide"
            ],
            placeholder: "Escribe tus ideas en formato Markdown...",
            shortcuts: {
                "toggleFullScreen": null,  // Desactivar Ctrl+Enter para pantalla completa
            }
        });
        
        // Sistema de guardado automático
        let saveTimeout;
        let autoSaveEnabled = true;
        let entryId = document.getElementById('entry_id').value;
        let lastSavedAt = new Date();
        
        function updateSaveStatus(status, isError = false) {
            const saveStatus = document.getElementById('save-status');
            const saveIcon = saveStatus.querySelector('.save-icon');
            const saveText = saveStatus.querySelector('.save-text');
            
            saveText.innerText = status;
            
            if (status === '') {
                saveIcon.classList.add('hidden');
            } else {
                saveIcon.classList.remove('hidden');
            }
            
            if (isError) {
                saveText.classList.add('text-red-600');
                saveIcon.classList.add('text-red-600');
            } else {
                saveText.classList.remove('text-red-600');
                saveIcon.classList.remove('text-red-600');
            }
        }
        
        function scheduleAutoSave() {
            if (!autoSaveEnabled) return;
            
            // Limpiar timer anterior
            if (saveTimeout) clearTimeout(saveTimeout);
            
            // Mostrar estado de guardado
            updateSaveStatus('Guardando...');
            
            // Programar nuevo guardado
            saveTimeout = setTimeout(autoSave, 2000);  // Debounce
        }
        
        function autoSave() {
            if (!autoSaveEnabled) return;
            
            const title = document.getElementById('title').value.trim();
            const content = easyMDE.value().trim();
            
            if (!title && !content) {
                updateSaveStatus('');
                return;
            }
            
            // Preparar datos
            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);
            
            // Realizar solicitud AJAX para autoguardado
            fetch(`${entryId === '0' ? '0' : entryId}/autosave`, {
                method: 'POST',
                body: formData,
                headers: {
                    'HX-Request': 'true'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Si es una entrada nueva, actualizar el ID
                    if (data.is_new) {
                        entryId = data.entry_id;
                        document.getElementById('entry_id').value = entryId;
                        
                        // Actualizar URL del formulario
                        document.getElementById('entry-form').action = `/entries/${entryId}`;
                        
                        // Actualizar historial del navegador sin recargar
                        window.history.replaceState(null, null, `/entries/${entryId}/edit`);
                    }
                    
                    lastSavedAt = new Date();
                    updateSaveStatus(`Guardado: ${data.last_saved || lastSavedAt.toLocaleTimeString()}`);
                    
                    // Ocultar estado después de un tiempo
                    setTimeout(() => {
                        updateSaveStatus('');
                    }, 3000);
                } else {
                    updateSaveStatus('Error al guardar', true);
                }
            })
            .catch(error => {
                console.error('Error al guardar:', error);
                updateSaveStatus('Error al guardar', true);
            });
        }
        
        // Vincular eventos para autoguardado
        document.getElementById('title').addEventListener('input', scheduleAutoSave);
        easyMDE.codemirror.on('change', scheduleAutoSave);
        
        // Funcionalidad para alternar tema claro/oscuro
        document.getElementById('theme-toggle').addEventListener('click', function() {
            document.body.classList.toggle('theme-light');
            document.body.classList.toggle('theme-dark');
            
            // Guardar preferencia en localStorage
            const isDarkMode = document.body.classList.contains('theme-dark');
            localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false');
        });
        
        // Cargar preferencia de tema al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.remove('theme-light');
                document.body.classList.add('theme-dark');
            }
            
            // Ajustar altura del editor para llenar el espacio disponible
            setTimeout(() => {
                const editor = document.querySelector('.CodeMirror');
                if (editor) {
                    editor.style.height = 'calc(70vh - 100px)';
                }
            }, 100);
        });
    </script>
</body>
</html> 